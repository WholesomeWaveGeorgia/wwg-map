<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../../bower_components/google-apis/google-maps-api.html"><link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html"><link rel="prefetch" href="../../bower_components/polymer/lib/mixins/element-mixin.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/boot.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/settings.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/resolve-url.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/mixin.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/case-map.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/style-gather.html"><link rel="prefetch" href="../../bower_components/polymer/lib/elements/dom-module.html"><link rel="prefetch" href="../../bower_components/polymer/lib/mixins/property-effects.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/path.html"><link rel="prefetch" href="../../bower_components/polymer/lib/mixins/property-accessors.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/async.html"><link rel="prefetch" href="../../bower_components/polymer/lib/mixins/template-stamp.html"><link rel="prefetch" href="../../bower_components/polymer/polymer.html"><link rel="prefetch" href="../../bower_components/polymer/lib/legacy/legacy-element-mixin.html"><link rel="prefetch" href="../../bower_components/shadycss/apply-shim.html"><link rel="prefetch" href="../../bower_components/shadycss/apply-shim.min.js"><link rel="prefetch" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/gestures.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/debounce.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/import-href.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/render-status.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/unresolved.html"><link rel="prefetch" href="../../bower_components/polymer/lib/legacy/polymer.dom.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/flattened-nodes-observer.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/array-splice.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/flush.html"><link rel="prefetch" href="../../bower_components/polymer/lib/legacy/polymer-fn.html"><link rel="prefetch" href="../../bower_components/polymer/lib/legacy/class.html"><link rel="prefetch" href="../../bower_components/polymer/lib/legacy/templatizer-behavior.html"><link rel="prefetch" href="../../bower_components/polymer/lib/utils/templatize.html"><link rel="prefetch" href="../../bower_components/polymer/lib/mixins/mutable-data.html"><link rel="prefetch" href="../../bower_components/polymer/lib/elements/dom-bind.html"><link rel="prefetch" href="../../bower_components/polymer/lib/elements/dom-repeat.html"><link rel="prefetch" href="../../bower_components/polymer/lib/elements/array-selector.html"><link rel="prefetch" href="../../bower_components/polymer/lib/elements/custom-style.html"><link rel="prefetch" href="../../bower_components/shadycss/custom-style-interface.html"><link rel="prefetch" href="../../bower_components/shadycss/custom-style-interface.min.js"><link rel="prefetch" href="../../bower_components/polymer/lib/legacy/mutable-data-behavior.html"><link rel="prefetch" href="../../bower_components/iron-ajax/iron-request.html"><link rel="prefetch" href="../../bower_components/iron-jsonp-library/iron-jsonp-library.html"></head><body><dom-module id="wwg-map"><template><style>:host{display:block;font-family:Arial;overflow:hidden;}.outerContainer{display:flex;display:-webkit-flex;flex-direction:column;-webkit-flex-direction:column;height:90vh;}.innerContainer{display:flex;display:-webkit-flex;flex-direction:column;-webkit-flex-direction:column;}h2{font-size:14px;margin-top:0;}a{text-decoration:none;color:inherit;}.header{background:#04793e;padding:12px;}.header:after{position:absolute;content:url('images/header_back.png');z-index:10;right:-4px;top:50px;}.my-location{margin-left:-38px;}.button.search{margin-left:32px;width:67px;border-color:#05522b;}label{color:#d6cbbb;padding:12px;display:inline-block;font-size:12px;text-align:center;width:62px;}input{width:calc(100% - 16px);padding:10px 0 10px 10px;border:0;display:inline-block;border-radius:0;}select{padding:8px;font-size:12px;width:132px;border:0;border-radius:0;background:#fff url('images/dropdown_arrow.png') no-repeat;background-position:110px center;-webkit-appearance:none;-moz-appearance:none;}.dropdowns{border-left:1px solid #d6cbbb;margin-top:12px;}.list{padding:12px;background:#d6cbbb;}.card{background:#efece8;border:1px solid #cccccc;padding:12px;margin-bottom:12px;display:flex;display:-webkit-flex;flex-wrap:wrap;-webkit-flex-wrap:wrap;}.card:last-child{margin-bottom:0;}.marketInfo{flex:1;-webkit-flex:1;padding-right:12px;}.address{color:#666666;font-size:11px;}.hours, .season{font-size:12px;min-width:100%;margin-bottom:0;}.season{font-weight:bold;margin-bottom:-10px;}.typeContainer{text-align:right;}.typeLabel{color:#fff;font-size:11px;padding:6px;display:block;text-align:center;margin-bottom:6px;}.typeLabel.market{background:#d95740;width:calc(100% - 12px);}.typeLabel.csa{background:#f09150;}.typeLabel.farm{background:#5c96b9;width:calc(100% - 12px);}.button{background:#f4f4f4;border:1px solid #cccccc;padding:6px 7px;border-radius:3px;display:inline-block;outline:none;}.button:hover{cursor:pointer;}.card .button{margin-left:2px;}.card .button:first-child{margin-left:0;}.button svg{width:16px;height:16px;vertical-align:middle;}span.tooltip, a.tooltip, button.tooltip{position:relative;display:inline-block;}span.tooltip span, a.tooltip span, button.tooltip span{position:absolute;font-size:13px;width:100px;color:#FFFFFF;background:#000000;height:30px;line-height:30px;text-align:center;visibility:hidden;border-radius:3px;}span.tooltip span:after, a.tooltip span:after, button.tooltip span:after{content:'';position:absolute;top:50%;left:100%;margin-top:-8px;width:0;height:0;border-left:8px solid #000000;border-top:8px solid transparent;border-bottom:8px solid transparent;}span:hover.tooltip span, a:hover.tooltip span, button:hover.tooltip span{visibility:visible;opacity:0.8;right:100%;top:50%;margin-top:-15px;margin-right:10px;z-index:999;}span.tooltip.csa span{padding:6px;line-height:14px;height:auto;width:140px;font-size:12px;}span.tooltip.csa span:after{top:16px;}@media (min-width: 601px){.button.tel{display:none;}.button.telPlaceholder{display:inline-block;}}@media (max-width: 600px){.button.tel{display:inline-block;}.button.telPlaceholder{display:none;}}@media (min-width: 736px){input{width:180px;}.dropdowns, .dropdown{display:inline-block;}.dropdowns{margin-left:32px;margin-top:0;}.header:after{top:-10px;}#map{width:60%;}.list{width:40%;height:100%;overflow:auto;}.innerContainer{overflow:hidden;flex-direction:row;-webkit-flex-direction:row;height:calc(100vh - 62px);}}@media (max-width: 735px){.list{height:calc(100vh - 223px);overflow-x:hidden;}#map{height:200px;}}@media (max-width: 800px){.button.search{display:none;}}</style><div class="outerContainer"><div class="header"><input id="search" placeholder="Address or Zipcode" type="text" value="{{addrValue::change}}"> <button type="button" class="my-location button tooltip" onclick="{{_getLocation}}"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 12 12" style="enable-background:new 0 0 12 12" xml:space="preserve"><path d="M6,3.8c-1.2,0-2.2,1-2.2,2.2s1,2.2,2.2,2.2s2.2-1,2.2-2.2S7.2,3.8,6,3.8z M10.9,5.5c-0.3-2.3-2.1-4.1-4.3-4.3V0H5.5v1.1
            	C3.2,1.4,1.4,3.2,1.1,5.5H0v1.1h1.1c0.3,2.3,2.1,4.1,4.3,4.3V12h1.1v-1.1c2.3-0.3,4.1-2.1,4.3-4.3H12V5.5C12,5.5,10.9,5.5,10.9,5.5z
            	 M6,9.8C3.9,9.8,2.2,8.1,2.2,6S3.9,2.2,6,2.2S9.8,3.9,9.8,6S8.1,9.8,6,9.8z"></path></svg> <span>my location</span></button><div class="dropdowns"><div class="dropdown"><label for="searchType">Search</label><select id="searchType" value="{{typeValue::change}}"><option value="" selected="">All Food Retailers</option><option value="market">Farmers Markets</option><option value="csa">CSAs</option><option value="farm">Farms</option></select></div><div class="dropdown"><label for="searchDistance">Within</label><select id="searchDistance" value="{{searchDistance::change}}"><option value="" selected="">Any Distance</option><option value="10">10 miles</option><option value="25">25 miles</option><option value="50">50 miles</option><option value="100">100 miles</option><option value="200">200 miles</option></select></div><button type="button" class="button search" id="searchButton">Search</button></div></div><iron-ajax id="marketData" auto="" url="https://sheets.googleapis.com/v4/spreadsheets/1KZih3C4gwp0-iyNrL_GGZhr90OuzqyAAQ6uaO6mEGmI/values/A2:J100" params="{&quot;key&quot;: &quot;AIzaSyBrEbVSGuOwOpnvrO9ETFCfcXdLSZfUKME&quot;}" handle-as="json" last-response="{{markets}}" debounce-duration="300"></iron-ajax><div class="innerContainer"><google-maps-api id="gMap" api-key="AIzaSyBrEbVSGuOwOpnvrO9ETFCfcXdLSZfUKME" version="3.29"></google-maps-api><div id="map"></div><div class="list"><template is="dom-if" if="{{searching}}"><p>Calculating distances...</p></template><template is="dom-if" if="{{_countCheck(counter)}}"><span>No retail partners meet that search criteria.</span></template><template is="dom-if" if="{{_noAddress(searchDistance, addrValue)}}"><span>Please provide an address or zipcode to use the distance filter.</span></template><template id="listTemplate" is="dom-repeat" items="{{marketsArr}}" as="market" rendered-item-count="{{counter}}" filter="{{_filterList(typeValue, searchDistance)}}" observe="distance"><div class="card"><div class="marketInfo"><h2><a href="{{market.website}}" target="_parent">{{market.title}}</a></h2><p class="address">{{market.street}}<br>{{market.city}}{{_getDistanceText(market.distance)}}</p></div><div class="typeContainer"><span class$="typeLabel {{_typeClass(market.type)}} tooltip">{{market.type}}<template is="dom-if" if="{{_csaCheck(market.type)}}"><span>A Community Supported Agriculture (CSA) share of produce is delivered weekly, or bi-weekly, to a convenient drop-off location in your neighborhood.</span></template></span><div><a class="tel button" href="tel:{{market.phone}}" target="_blank"><svg fill="#000000" height="12" viewBox="0 0 12 12" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M2.4,5.2c1,1.9,2.5,3.4,4.4,4.4l1.5-1.5C8.5,7.9,8.7,7.9,9,8c0.7,0.2,1.6,0.4,2.4,0.4C11.7,8.3,12,8.6,12,9v2.3
          c0,0.4-0.3,0.7-0.7,0.7C5.1,12,0,6.9,0,0.7C0,0.3,0.3,0,0.7,0H3c0.4,0,0.7,0.3,0.7,0.7C3.7,1.5,3.8,2.3,4,3c0.1,0.2,0,0.5-0.2,0.7
          L2.4,5.2z"></path></svg> </a><span class="telPlaceholder button tooltip"><svg fill="#000000" height="12" viewBox="0 0 12 12" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M2.4,5.2c1,1.9,2.5,3.4,4.4,4.4l1.5-1.5C8.5,7.9,8.7,7.9,9,8c0.7,0.2,1.6,0.4,2.4,0.4C11.7,8.3,12,8.6,12,9v2.3
          c0,0.4-0.3,0.7-0.7,0.7C5.1,12,0,6.9,0,0.7C0,0.3,0.3,0,0.7,0H3c0.4,0,0.7,0.3,0.7,0.7C3.7,1.5,3.8,2.3,4,3c0.1,0.2,0,0.5-0.2,0.7
          L2.4,5.2z"></path></svg> <span>{{market.phone}}</span> </span><a class="button tooltip" href="https://www.google.ca/maps/dir/my+location/{{market.street}}+{{market.city}}" target="_parent"><svg fill="#000000" height="12" viewBox="0 0 12 12" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M12,0L0,5v0.7l4.6,1.8L6.3,12H7L12,0z"></path></svg> <span>directions</span> </a><a class="button tooltip" href="{{market.website}}" target="_parent"><svg fill="#000000" height="12" viewBox="0 0 12 12" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M6,0C2.7,0,0,2.7,0,6s2.7,6,6,6c3.3,0,6-2.7,6-6S9.3,0,6,0z M10.2,3.6H8.4C8.2,2.8,7.9,2.1,7.6,1.5
          C8.7,1.8,9.6,2.6,10.2,3.6z M6,1.2c0.5,0.7,0.9,1.5,1.1,2.4H4.9C5.1,2.7,5.5,1.9,6,1.2z M1.4,7.2C1.3,6.8,1.2,6.4,1.2,6
          s0.1-0.8,0.2-1.2h2c0,0.4-0.1,0.8-0.1,1.2s0,0.8,0.1,1.2H1.4z M1.8,8.4h1.8c0.2,0.8,0.5,1.5,0.8,2.1C3.3,10.2,2.4,9.4,1.8,8.4z
           M3.6,3.6H1.8c0.6-1,1.5-1.8,2.6-2.1C4.1,2.1,3.8,2.8,3.6,3.6z M6,10.8c-0.5-0.7-0.9-1.5-1.1-2.4h2.3C6.9,9.3,6.5,10.1,6,10.8z
           M7.4,7.2H4.6C4.5,6.8,4.5,6.4,4.5,6s0-0.8,0.1-1.2h2.8C7.5,5.2,7.5,5.6,7.5,6S7.5,6.8,7.4,7.2z M7.6,10.5c0.4-0.7,0.6-1.4,0.8-2.1
          h1.8C9.6,9.4,8.7,10.2,7.6,10.5z M8.6,7.2c0-0.4,0.1-0.8,0.1-1.2s0-0.8-0.1-1.2h2c0.1,0.4,0.2,0.8,0.2,1.2s-0.1,0.8-0.2,1.2H8.6z"></path></svg> <span>website</span></a></div></div><template is="dom-if" if="{{market.season}}"><p class="season">{{market.season}}</p></template><p class="hours">{{market.hours}}</p></div></template></div></div></div></template><script>var WwgMap=function(c){function f(){return babelHelpers.classCallCheck(this,f),babelHelpers.possibleConstructorReturn(this,(f.__proto__||Object.getPrototypeOf(f)).apply(this,arguments))}return babelHelpers.inherits(f,c),babelHelpers.createClass(f,[{key:'ready',value:function(){var h=this;babelHelpers.get(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),'ready',this).call(this),this.$.gMap.addEventListener('api-load',function(){var j=h.$.search,k=new google.maps.places.Autocomplete(j);window.WwgMapObj=new google.maps.Map(h.$.map,{zoom:10,center:{lat:33.790586,lng:-84.37395},fullscreenControlOptions:{position:5},zoomControlOptions:{position:4},mapTypeControl:!1,streetViewControl:!1}),h.addEventListener('marketsDataReady',function(l){h.createMarkers(l.detail.marketsData)}),google.maps.event.addListener(k,'place_changed',function(){var l=k.getPlace();console.log('autocomplete place',l),l.geometry?h._moveToLocation(l.geometry.location.lat(),l.geometry.location.lng()):h._moveToLocation(l.name),h.updateDistances()}),j.addEventListener('blur',function(l){h.updateDistances(l)}),j.addEventListener('keyup',function(l){13===l.keyCode&&(h.updateDistances(l),h._moveToLocation(j.value))}),h.$.searchButton.addEventListener('click',function(l){h.updateDistances(l),h._moveToLocation(j.value)})})}},{key:'updateDistances',value:function(h){var j=this;this._debouncer=Polymer.Debouncer.debounce(this._debouncer,Polymer.Async.timeOut.after(500),function(){if(j.$.search.value){j.searching=!0;var k=new google.maps.DistanceMatrixService,l=[],m=[],o=j.marketsArr.map(function(r){return r.street+' '+r.city});j.numSegments=Math.ceil(o.length/25);var p=function(){setTimeout(function(){return!0},2e3)},q=function r(s){0===s?(m=l.map(function(u,w){var y=Object.assign({},j.marketsArr[w]);return y.distance=u.distance?u.distance.text:'',''===y.distance&&console.log(y),y}),console.log('all results',m),m.sort(function(u,w){var y=u.distance.includes(' mi')?parseInt(u.distance.replace(' mi','')):parseInt(u.distance.replace(' ft',''))/5280,z=w.distance.includes(' mi')?parseInt(w.distance.replace(' mi','')):parseInt(w.distance.replace(' ft',''))/5280;return y<z?-1:y>z?1:0}),j.marketsArr=m,j.clearMarkers(),j.createMarkers(m),j.$.listTemplate.render(),j.searching=!1):k.getDistanceMatrix({origins:[j.$.search.value],destinations:o.slice(25*(s-1),25*s),travelMode:'DRIVING',unitSystem:google.maps.UnitSystem.IMPERIAL},function(u,w){console.log('status',w),'OK'===w&&(console.log('lookup section',o.slice(25*(s-1),25*s)),console.log('results',s-1,u.rows[0].elements),l.unshift.apply(l,babelHelpers.toConsumableArray(u.rows[0].elements)),r(s-1)),'UNKNOWN_ERROR'===w&&(console.log(s-1,'UNKNOWN_ERROR trying again'),r(s)),'OVER_QUERY_LIMIT'===w&&(console.log(s-1,'OVER_QUERY_LIMIT trying again in a moment'),p(),r(s)),p(),console.log(window.performance.now())})};console.log('sendRequests',j.numSegments,h),q(j.numSegments)}})}},{key:'_getAddresses',value:function(){return 0===v}},{key:'_countCheck',value:function(h){return 0===h}},{key:'_noAddress',value:function(h,j){return h&&''==j}},{key:'clearMarkers',value:function(){this.markers.forEach(function(h){h.setMap(null)})}},{key:'createMarkers',value:function(h){var j=new google.maps.InfoWindow,k=[];h.map(function(l){var m=new google.maps.LatLng(parseFloat(l.lat),parseFloat(l.lng)),o=new google.maps.Marker({position:m,map:window.WwgMapObj,title:l.title,type:l.type,distance:l.distance});k.push(o),google.maps.event.addListener(o,'click',function(p,q){return function(){j.setContent('\n                <div style="max-width:250px;">\n                  <h2 style="font-size: 15px; margin-top: 0;">'+q.title+'</h2>\n                  <p style="color: #666666; font-size: 11px;">'+q.street+'<br>'+q.city+' - <a style="color: inherit;" href="https://www.google.ca/maps/dir/my+location/'+q.street+'+'+q.city+'" target="_blank">Directions</a></p>\n                  <p style="font-size: 12px;">'+q.hours+'</p>\n                </div>\n                '),j.open(window.WwgMapObj,p)}}(o,l))}),this.markers=k}},{key:'_marketDataChanged',value:function(h){this.marketsArr=h.values.map(function(j){return{title:j[0],type:j[1],street:j[2],city:j[3],season:j[4],hours:j[5],website:j[6],phone:j[7],lat:j[8],lng:j[9],distance:''}}),this.dispatchEvent(new CustomEvent('marketsDataReady',{detail:{marketsData:this.marketsArr}}))}},{key:'_typeClass',value:function(h){var j;return'Farmers Market'===h?j='market':'CSA'===h?j='csa':'Farm'===h?j='farm':void 0,j}},{key:'_csaCheck',value:function(h){return'CSA'===h}},{key:'_getLocation',value:function(){if(!navigator.geolocation)return void alert('Geolocation is not supported by your browser');console.log('Locating\u2026'),navigator.geolocation.getCurrentPosition(function(l){var m=l.coords.latitude,o=l.coords.longitude;window.WwgMapObj.setCenter({lat:m,lng:o}),window.WwgMapObj.setZoom(14)},function(l){alert('Unable to retrieve your location',l)})}},{key:'_moveToLocation',value:function(h,j){var k=this;if(h&&j)window.WwgMapObj.setCenter({lat:h,lng:j});else{var l=new google.maps.Geocoder;l.geocode({address:h},function(m,o){'OK'===o&&(console.log(k.$.search.value,'geocode status OK',m,{lat:m[0].geometry.location.lat(),lng:m[0].geometry.location.lng()}),window.WwgMapObj.setCenter({lat:m[0].geometry.location.lat(),lng:m[0].geometry.location.lng()})),'UNKNOWN_ERROR'===o&&console.log('geocode failure - can\'t move to searched location',m)})}window.WwgMapObj.setZoom(13)}},{key:'_getDistanceText',value:function(h){return''===h?null:' \u2022 '+h}},{key:'_filterList',value:function(h,j){var k=this;return h||j?(console.log('computeFilter'),function(l){var m=l.distance,o=l.type,p=k.$.search.value;return h&&j&&''!==p?k._typeClass(o)===h&&(/ft/.test(m)||parseFloat(m.substring(0,m.length-3))<j):h&&!j?k._typeClass(o)===h:!h&&j&&''!==p?/ft/.test(m)||parseFloat(m.substring(0,m.length-3))<j:void 0}):null}},{key:'_filterMarkers',value:function(){var h=this;console.log('_filterMarkers');var j=this.typeValue,k=this.searchDistance;j||k?this.markers.forEach(function(l){var m=l.distance,o=l.type,p=h.$.search.value;j&&k&&''!==p&&(h._typeClass(o)===j&&(/ft/.test(m)||parseFloat(m.substring(0,m.length-3))<k)?l.setVisible(!0):l.setVisible(!1)),j&&!k&&(h._typeClass(o)===j?l.setVisible(!0):l.setVisible(!1)),!j&&k&&''!==p&&(/ft/.test(m)||parseFloat(m.substring(0,m.length-3))<k?(console.log('show',m,/ft/.test(m)),l.setVisible(!0)):(console.log('don\'t show',m,/ft/.test(m)),l.setVisible(!1)))}):this.markers.forEach(function(l){l.setVisible(!0)})}}],[{key:'is',get:function(){return'wwg-map'}},{key:'properties',get:function(){return{searching:{type:Boolean,value:!1},typeValue:{type:String},markets:{type:Object},addrLookupArr:{type:Array},addrResultsArr:{type:Array,value:[]}}}},{key:'observers',get:function(){return['_marketDataChanged(markets)','_filterMarkers(typeValue, searchDistance)']}}]),f}(Polymer.Element);window.customElements.define(WwgMap.is,WwgMap);</script></dom-module></body></html>